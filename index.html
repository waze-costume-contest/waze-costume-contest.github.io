<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waze Costume Contest 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Official-ish Waze Palette */
            --waze-cyan: #33CCFF;
            --waze-blue-dark: #0091C8;
            --waze-green: #93E223;
            --waze-yellow: #FFC400;
            --waze-orange: #FF8F00;
            --waze-red: #FF5C5C;
            --waze-purple: #C290C6;
            --waze-dark: #4A435C;
            --waze-offwhite: #F2F4F7;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--waze-offwhite);
            color: var(--waze-dark);
            /* Subtle Road Pattern Background */
            background-image: radial-gradient(#dbe0e8 15%, transparent 16%), radial-gradient(#dbe0e8 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        /* Waze Card Style - Puffy and soft */
        .waze-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 0 #e5e7eb, 0 8px 20px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #fff;
        }
        
        .waze-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 0 #e5e7eb, 0 12px 24px rgba(0,0,0,0.1);
        }

        /* The iconic Report Button style */
        .btn-waze-action {
            background-color: var(--waze-yellow);
            color: white;
            border-bottom: 4px solid var(--waze-orange);
            transition: all 0.1s;
        }
        .btn-waze-action:active {
            border-bottom-width: 0px;
            transform: translateY(4px);
        }

        .btn-waze-primary {
            background-color: var(--waze-cyan);
            color: white;
            border-bottom: 4px solid var(--waze-blue-dark);
        }
        .btn-waze-primary:active {
            border-bottom-width: 0px;
            transform: translateY(4px);
        }

        /* Headings */
        h1, h2, h3 {
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        /* Mood Bubble (Avatar placeholder) */
        .mood-bg {
            background: radial-gradient(circle at 30% 30%, var(--waze-cyan), #0091C8);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 3px solid var(--waze-offwhite); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="sticky top-4 z-50 px-4">
        <div class="container mx-auto max-w-5xl bg-white/90 backdrop-blur-md rounded-full shadow-lg border border-gray-100 p-3 flex justify-between items-center">
            <div class="flex items-center gap-3 pl-2">
                <div class="mood-bg w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-inner border-2 border-white">
                    üëª
                </div>
                <h1 class="text-xl md:text-2xl font-extrabold text-[#4A435C]">
                    Costume<span class="text-[#33CCFF]">Contest</span>
                </h1>
            </div>
            
            <button onclick="openUploadModal()" class="hidden md:flex bg-[#33CCFF] hover:bg-[#2ebbe6] text-white font-bold py-2 px-6 rounded-full shadow-md transition items-center gap-2 border-b-4 border-[#0091C8] active:border-b-0 active:translate-y-1">
                <span>Upload Costume</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
            </button>
        </div>
    </header>

    <main class="container mx-auto max-w-5xl p-4 flex-grow relative z-10">
        
        <div class="text-center py-8">
            <h2 class="text-4xl md:text-5xl font-black text-[#4A435C] mb-2">Who's the best dressed?</h2>
            <p class="text-gray-500 font-semibold text-lg">Vote for your favorite Wazer.</p>
        </div>

        <div id="costume-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
            <div class="col-span-full text-center py-20">
                <div class="inline-block animate-bounce text-4xl mb-4">üöô</div>
                <p class="text-xl font-bold text-gray-400">Driving to destination...</p>
            </div>
        </div>

        <section class="mt-16 mb-20">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-[#93E223] w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-md transform -rotate-3">
                    üèÜ
                </div>
                <h2 class="text-3xl font-bold text-[#4A435C]">Leaderboard</h2>
            </div>
            
            <div class="bg-white rounded-[2rem] shadow-xl border-4 border-white overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr class="text-gray-400 text-sm uppercase tracking-wider">
                                <th class="p-4 pl-6 font-bold">Rank</th>
                                <th class="p-4 font-bold">Wazer</th>
                                <th class="p-4 font-bold">Costume</th>
                                <th class="p-4 pr-6 text-right font-bold">Votes</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-list" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <button onclick="openUploadModal()" class="md:hidden fixed bottom-6 right-6 w-16 h-16 bg-[#FFC400] rounded-full shadow-2xl flex items-center justify-center text-white border-b-4 border-[#FF8F00] active:border-b-0 active:translate-y-1 z-40">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
    </button>

    <div id="upload-modal" class="fixed inset-0 bg-[#4A435C]/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 transition-opacity">
        <div class="bg-white rounded-[2rem] w-full max-w-md overflow-hidden shadow-2xl transform transition-all border-4 border-white relative">
            
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-black text-[#4A435C]">New Entry</h3>
                    <button onclick="closeUploadModal()" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full transition">
                        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <form id="upload-form" onsubmit="handleUpload(event)" class="space-y-5">
                    <div>
                        <div class="border-4 border-dashed border-gray-200 rounded-3xl p-8 text-center cursor-pointer hover:border-[#33CCFF] hover:bg-blue-50 transition group" onclick="document.getElementById('file-input').click()">
                            <input type="file" id="file-input" class="hidden" accept="image/*" required onchange="previewImage(this)">
                            <div id="image-preview-area" class="group-hover:scale-110 transition duration-300">
                                <div class="w-16 h-16 bg-blue-100 text-[#33CCFF] rounded-full mx-auto flex items-center justify-center mb-2">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <p class="text-sm font-bold text-gray-400">Tap to snap</p>
                            </div>
                            <img id="preview-img" class="hidden w-full h-48 object-cover rounded-2xl shadow-sm">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-500 text-xs font-bold uppercase ml-3 mb-1">Your LDAP</label>
                            <input type="text" id="uploader-ldap" class="w-full px-5 py-3 bg-gray-50 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-[#33CCFF] focus:bg-white font-bold text-[#4A435C]" placeholder="e.g. jdoe" required>
                        </div>
                        <div>
                            <label class="block text-gray-500 text-xs font-bold uppercase ml-3 mb-1">Costume Name</label>
                            <input type="text" id="costume-name" class="w-full px-5 py-3 bg-gray-50 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-[#33CCFF] focus:bg-white font-bold text-[#4A435C]" placeholder="e.g. Traffic Jam" required>
                        </div>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full btn-waze-primary font-black py-4 rounded-xl text-lg shadow-lg mt-2">
                        Post to Map
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="vote-modal" class="fixed inset-0 bg-[#4A435C]/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-sm shadow-2xl border-4 border-white overflow-hidden">
            <div class="bg-[#FFC400] p-6 text-center">
                <div class="bg-white/20 w-16 h-16 rounded-full mx-auto flex items-center justify-center text-3xl mb-2 backdrop-blur-sm">üëç</div>
                <h3 class="text-2xl font-black text-white">Awesome!</h3>
            </div>
            <form id="vote-form" onsubmit="handleVote(event)" class="p-6 space-y-4">
                <input type="hidden" id="vote-costume-id">
                <p class="text-gray-500 font-medium text-center text-sm">Verify your LDAP to count this vote.</p>
                
                <input type="text" id="voter-ldap" class="w-full px-5 py-3 bg-gray-50 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-[#FFC400] focus:bg-white font-bold text-center text-[#4A435C]" placeholder="Your LDAP" required>
                
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" onclick="closeVoteModal()" class="py-3 px-4 rounded-xl font-bold text-gray-400 hover:bg-gray-100 transition">Cancel</button>
                    <button type="submit" class="btn-waze-action rounded-xl font-black py-3 px-4 shadow-md">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 -translate-y-32 transition-all duration-500 z-[60] bg-[#4A435C] text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 font-bold border-2 border-white/10">
        <span id="toast-icon" class="text-xl">‚úÖ</span>
        <span id="toast-msg">Notification</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfx3wajLL12k12Yq43rvcqedRRjnKK92Y",
            authDomain: "waze-costume-party.firebaseapp.com",
            projectId: "waze-costume-party",
            storageBucket: "waze-costume-party.firebasestorage.app",
            messagingSenderId: "1057125475439",
            appId: "1:1057125475439:web:2e1042532a0bbd572f199a",
            measurementId: "G-RZX6ZTPFNB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'waze-costumes-default';
        const COSTUMES_COLLECTION_PATH = ['artifacts', appId, 'public', 'data', 'contest_entries'];

        let costumes = [];
        let currentUser = null;

        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                currentUser = auth.currentUser;
                setupRealtimeListener();
            } catch (error) {
                console.error("Auth failed", error);
                showToast("Error connecting", "‚ùå");
            }
        }
        init();

        function setupRealtimeListener() {
            const colRef = collection(db, ...COSTUMES_COLLECTION_PATH);
            onSnapshot(colRef, (snapshot) => {
                costumes = [];
                snapshot.forEach(doc => {
                    costumes.push({ id: doc.id, ...doc.data() });
                });
                renderGrid();
                renderRankings();
            });
        }

        function renderGrid() {
            const grid = document.getElementById('costume-grid');
            if (costumes.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-12 text-gray-400">
                        <span class="text-6xl mb-4 opacity-50">üó∫Ô∏è</span>
                        <p class="text-xl font-bold">Map is empty!</p>
                        <p class="text-sm">Be the first to add a sighting.</p>
                    </div>`;
                return;
            }

            const sortedCostumes = [...costumes].sort((a, b) => b.createdAt - a.createdAt);

            grid.innerHTML = sortedCostumes.map(c => {
                const voteCount = c.voters ? c.voters.length : 0;
                return `
                    <div class="waze-card group flex flex-col h-full overflow-hidden relative">
                        <div class="relative h-64 overflow-hidden bg-gray-100 rounded-t-[1.3rem]">
                            <img src="${c.image}" alt="${c.costumeName}" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-700">
                            <div class="absolute top-3 right-3 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-black text-[#FFC400] shadow-sm flex items-center gap-1">
                                <span>üëç</span> ${voteCount}
                            </div>
                        </div>
                        <div class="p-5 flex flex-col flex-grow">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h3 class="text-xl font-black text-[#4A435C] leading-tight mb-1">${escapeHtml(c.costumeName)}</h3>
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">@${escapeHtml(c.ldap)}</p>
                                </div>
                            </div>
                            
                            <div class="mt-auto pt-4">
                                <button onclick="window.openVoteModal('${c.id}')" class="w-full bg-[#f0f4f9] hover:bg-[#e2eaf5] text-[#33CCFF] font-black py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center gap-2 group-hover:bg-[#33CCFF] group-hover:text-white">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path></svg>
                                    Like
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRankings() {
            const list = document.getElementById('ranking-list');
            const sorted = [...costumes].sort((a, b) => {
                const votesA = a.voters ? a.voters.length : 0;
                const votesB = b.voters ? b.voters.length : 0;
                return votesB - votesA;
            });

            list.innerHTML = sorted.map((c, index) => {
                const votes = c.voters ? c.voters.length : 0;
                let rankStyle = "text-gray-400 font-bold";
                let rankIcon = `#${index + 1}`;
                
                if (index === 0) { rankIcon = "ü•á"; rankStyle = "text-2xl"; }
                if (index === 1) { rankIcon = "ü•à"; rankStyle = "text-xl"; }
                if (index === 2) { rankIcon = "ü•â"; rankStyle = "text-xl"; }

                return `
                    <tr class="hover:bg-blue-50/50 transition duration-150">
                        <td class="p-4 pl-6 align-middle ${rankStyle}">${rankIcon}</td>
                        <td class="p-4 align-middle">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full mood-bg flex items-center justify-center text-white text-xs font-bold">
                                    ${c.ldap.charAt(0).toUpperCase()}
                                </div>
                                <span class="font-bold text-[#4A435C]">${escapeHtml(c.ldap)}</span>
                            </div>
                        </td>
                        <td class="p-4 text-sm font-semibold text-gray-500">${escapeHtml(c.costumeName)}</td>
                        <td class="p-4 pr-6 text-right font-black text-[#33CCFF] text-lg">${votes}</td>
                    </tr>
                `;
            }).join('');
        }

        window.handleUpload = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const fileInput = document.getElementById('file-input');
            const ldap = document.getElementById('uploader-ldap').value.trim();
            const name = document.getElementById('costume-name').value.trim();

            if (!fileInput.files[0]) {
                showToast("Photo needed!", "üì∏");
                return;
            }

            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `Uploading...`;
            btn.classList.add('opacity-70');

            try {
                const base64Image = await compressImage(fileInput.files[0]);
                const colRef = collection(db, ...COSTUMES_COLLECTION_PATH);
                await addDoc(colRef, {
                    ldap: ldap,
                    costumeName: name,
                    image: base64Image,
                    voters: [],
                    createdAt: Date.now()
                });

                showToast("Sent to Map!", "üëª");
                closeUploadModal();
                e.target.reset();
                document.getElementById('image-preview-area').style.display = 'block';
                document.getElementById('preview-img').classList.add('hidden');
            } catch (error) {
                console.error("Upload error", error);
                showToast("Upload failed.", "‚ùå");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
                btn.classList.remove('opacity-70');
            }
        };

        window.handleVote = async (e) => {
            e.preventDefault();
            const costumeId = document.getElementById('vote-costume-id').value;
            const voterLdap = document.getElementById('voter-ldap').value.trim().toLowerCase();

            if (!voterLdap) return;

            // Optimistic UI check
            const costume = costumes.find(c => c.id === costumeId);
            if (costume && costume.voters && costume.voters.map(v => v.toLowerCase()).includes(voterLdap)) {
                showToast("Already voted!", "‚úã");
                closeVoteModal();
                return;
            }

            try {
                const docRef = doc(db, ...COSTUMES_COLLECTION_PATH, costumeId);
                const freshDoc = await getDoc(docRef);
                
                if (freshDoc.exists()) {
                    const data = freshDoc.data();
                    const currentVoters = data.voters || [];
                    
                    if (currentVoters.map(v => v.toLowerCase()).includes(voterLdap)) {
                        showToast("Already voted!", "‚úã");
                    } else {
                        await updateDoc(docRef, { voters: arrayUnion(voterLdap) });
                        showToast("Vote Counted!", "üó≥Ô∏è");
                    }
                }
                closeVoteModal();
            } catch (error) {
                console.error("Vote error", error);
                showToast("Vote failed.", "‚ùå");
            }
        };

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function showToast(message, icon) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = message;
            document.getElementById('toast-icon').textContent = icon;
            
            toast.classList.remove('-translate-y-32');
            toast.classList.add('translate-y-0');
            setTimeout(() => {
                toast.classList.remove('translate-y-0');
                toast.classList.add('-translate-y-32');
            }, 3000);
        }

        window.openUploadModal = () => document.getElementById('upload-modal').classList.remove('hidden');
        window.closeUploadModal = () => document.getElementById('upload-modal').classList.add('hidden');
        
        window.openVoteModal = (id) => {
            document.getElementById('vote-costume-id').value = id;
            document.getElementById('vote-modal').classList.remove('hidden');
            document.getElementById('voter-ldap').focus();
        };
        window.closeVoteModal = () => document.getElementById('vote-modal').classList.add('hidden');

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('image-preview-area').style.display = 'none';
                    const img = document.getElementById('preview-img');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.onclick = function(event) {
            const upModal = document.getElementById('upload-modal');
            const vModal = document.getElementById('vote-modal');
            if (event.target == upModal) closeUploadModal();
            if (event.target == vModal) closeVoteModal();
        }
    </script>
</body>
</html>
